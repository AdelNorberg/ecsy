!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):(e=e||self,function(){var s=e.ECSY,o=e.ECSY={};t(o),o.noConflict=function(){return e.ECSY=s,o}}())}(this,(function(exports){"use strict";class SystemManager{constructor(e){this._systems=[],this._executeSystems=[],this.world=e,this.lastExecutedSystem=null}registerSystem(e,t){if(void 0!==this._systems.find(t=>t.constructor.name===e.name))return console.warn(`System '${e.name}' already registered.`),this;var s=new e(this.world,t);return s.init&&s.init(),s.order=this._systems.length,this._systems.push(s),s.execute&&(this._executeSystems.push(s),this.sortSystems()),this}sortSystems(){this._executeSystems.sort((e,t)=>e.priority-t.priority||e.order-t.order)}getSystem(e){return this._systems.find(t=>t instanceof e)}getSystems(){return this._systems}removeSystem(e){var t=this._systems.indexOf(e);~t&&this._systems.splice(t,1)}executeSystem(e,t,s){if(e.initialized&&e.canExecute()){let o=performance.now();e.execute(t,s),e.executeTime=performance.now()-o,this.lastExecutedSystem=e,e.clearEvents()}}stop(){this._executeSystems.forEach(e=>e.stop())}execute(e,t,s){this._executeSystems.forEach(o=>(s||o.enabled)&&this.executeSystem(o,e,t))}stats(){for(var e={numSystems:this._systems.length,systems:{}},t=0;t<this._systems.length;t++){var s=this._systems[t],o=e.systems[s.constructor.name]={queries:{}};for(var n in s.ctx)o.queries[n]=s.ctx[n].stats()}return e}}var name="ecsy",version="0.2.2",description="Entity Component System in JS",main="build/ecsy.js",module="build/ecsy.module.js",types="src/index.d.ts",scripts={build:"rollup -c && npm run docs",docs:"rm docs/api/_sidebar.md; typedoc --readme none --mode file --excludeExternals --plugin typedoc-plugin-markdown  --theme docs/theme --hideSources --hideBreadcrumbs --out docs/api/ --includeDeclarations --includes 'src/**/*.d.ts' src; touch docs/api/_sidebar.md","dev:docs":"nodemon -e ts -x 'npm run docs' -w src",dev:"concurrently --names 'ROLLUP,DOCS,HTTP' -c 'bgBlue.bold,bgYellow.bold,bgGreen.bold' 'rollup -c -w -m inline' 'npm run dev:docs' 'npm run dev:server'","dev:server":"http-server -c-1 -p 8080 --cors",lint:"eslint src test examples",start:"npm run dev",test:"ava",travis:"npm run lint && npm run test && npm run build","watch:test":"ava --watch"},repository={type:"git",url:"git+https://github.com/fernandojsg/ecsy.git"},keywords=["ecs","entity component system"],author="Fernando Serrano <fernandojsg@gmail.com> (http://fernandojsg.com)",license="MIT",bugs={url:"https://github.com/fernandojsg/ecsy/issues"},ava={files:["test/**/*.test.js"],sources:["src/**/*.js"],require:["babel-register","esm"]},jspm={files:["package.json","LICENSE","README.md","build/ecsy.js","build/ecsy.min.js","build/ecsy.module.js"],directories:{}},homepage="https://github.com/fernandojsg/ecsy#readme",devDependencies={ava:"^1.4.1","babel-cli":"^6.26.0","babel-core":"^6.26.3","babel-eslint":"^10.0.3","babel-loader":"^8.0.6",concurrently:"^4.1.2","docsify-cli":"^4.4.0",eslint:"^5.16.0","eslint-config-prettier":"^4.3.0","eslint-plugin-prettier":"^3.1.2","http-server":"^0.11.1",nodemon:"^1.19.4",prettier:"^1.19.1",rollup:"^1.29.0","rollup-plugin-json":"^4.0.0","rollup-plugin-terser":"^5.2.0",typedoc:"^0.15.8","typedoc-plugin-markdown":"^2.2.16",typescript:"^3.7.5"},pjson={name:name,version:version,description:description,main:main,"jsnext:main":"build/ecsy.module.js",module:module,types:types,scripts:scripts,repository:repository,keywords:keywords,author:author,license:license,bugs:bugs,ava:ava,jspm:jspm,homepage:homepage,devDependencies:devDependencies};const Version=pjson.version;class EventDispatcher{constructor(){this._listeners={},this.stats={fired:0,handled:0}}addEventListener(e,t){let s=this._listeners;void 0===s[e]&&(s[e]=[]),-1===s[e].indexOf(t)&&s[e].push(t)}hasEventListener(e,t){return void 0!==this._listeners[e]&&-1!==this._listeners[e].indexOf(t)}removeEventListener(e,t){var s=this._listeners[e];if(void 0!==s){var o=s.indexOf(t);-1!==o&&s.splice(o,1)}}dispatchEvent(e,t,s){this.stats.fired++;var o=this._listeners[e];if(void 0!==o)for(var n=o.slice(0),i=0;i<n.length;i++)n[i].call(this,t,s)}resetCounters(){this.stats.fired=this.stats.handled=0}}function queryKey(e){for(var t=[],s=0;s<e.length;s++){var o=e[s];if("object"==typeof o){var n="not"===o.operator?"!":o.operator;t.push(n+o.Component.name)}else t.push(o.name)}return t.sort().join("-")}let _lut=[];for(let e=0;e<256;e++)_lut[e]=(e<16?"0":"")+e.toString(16);function generateUUID(){let e=4294967295*Math.random()|0,t=4294967295*Math.random()|0,s=4294967295*Math.random()|0,o=4294967295*Math.random()|0;return(_lut[255&e]+_lut[e>>8&255]+_lut[e>>16&255]+_lut[e>>24&255]+"-"+_lut[255&t]+_lut[t>>8&255]+"-"+_lut[t>>16&15|64]+_lut[t>>24&255]+"-"+_lut[63&s|128]+_lut[s>>8&255]+"-"+_lut[s>>16&255]+_lut[s>>24&255]+_lut[255&o]+_lut[o>>8&255]+_lut[o>>16&255]+_lut[o>>24&255]).toUpperCase()}class Query{constructor(e,t){if(this.Components=[],this.NotComponents=[],e.forEach(e=>{"object"==typeof e?this.NotComponents.push(e.Component):this.Components.push(e)}),0===this.Components.length)throw new Error("Can't create a query without components");this.entities=[],this.eventDispatcher=new EventDispatcher,this.reactive=!1,this.key=queryKey(e);for(var s=0;s<t.entities.length;s++){var o=t.entities[s];this.match(o)&&(o.queries.push(this),this.entities.push(o))}}addEntity(e){e.queries.push(this),this.entities.push(e),this.eventDispatcher.dispatchEvent(Query.prototype.ENTITY_ADDED,e)}removeEntity(e){let t=this.entities.indexOf(e);~t&&(this.entities.splice(t,1),t=e.queries.indexOf(this),e.queries.splice(t,1),this.eventDispatcher.dispatchEvent(Query.prototype.ENTITY_REMOVED,e))}match(e){return e.hasAllComponents(this.Components)&&!e.hasAnyComponents(this.NotComponents)}toJSON(){return{key:this.key,reactive:this.reactive,components:{included:this.Components.map(e=>e.name),not:this.NotComponents.map(e=>e.name)},numEntities:this.entities.length}}stats(){return{numComponents:this.Components.length,numEntities:this.entities.length}}}Query.prototype.ENTITY_ADDED="Query#ENTITY_ADDED",Query.prototype.ENTITY_REMOVED="Query#ENTITY_REMOVED",Query.prototype.COMPONENT_CHANGED="Query#COMPONENT_CHANGED";const copyValue=(e,t,s)=>t[s]=e[s],cloneValue=e=>e,copyArray=(e,t,s)=>{const o=e[s],n=t[s];n.length=0;for(let e=0;e<o.length;e++)n.push(o[e]);return n},cloneArray=e=>e.slice(),copyJSON=(e,t,s)=>t[s]=JSON.parse(JSON.stringify(e[s])),cloneJSON=e=>JSON.parse(JSON.stringify(e)),copyCopyable=(e,t,s)=>t[s].copy(e[s]),cloneClonable=e=>e.clone(),Types=new Map;Types.set(Number,{default:0,clone:cloneValue,copy:copyValue}),Types.set(Boolean,{default:!1,clone:cloneValue,copy:copyValue}),Types.set(String,{default:"",clone:cloneValue,copy:copyValue}),Types.set(Object,{default:void 0,clone:cloneValue,copy:copyValue}),Types.set(Array,{default:[],clone:cloneArray,copy:copyArray}),Types.set(JSON,{default:null,clone:cloneJSON,copy:copyJSON});class Entity{constructor(e){this.world=e,this.uuid=generateUUID(),this.componentTypes=[],this.components={},this._componentsToRemove={},this.queries=[],this._componentTypesToRemove=[],this.alive=!1,this._numSystemStateComponents=0}getComponent(e,t){var s=this.components[e.name];return s||!0!==t||(s=this._componentsToRemove[e.name]),s}getRemovedComponent(e){return this._componentsToRemove[e.name]}getComponents(){return this.components}getComponentsToRemove(){return this._componentsToRemove}getComponentTypes(){return this.componentTypes}getMutableComponent(e){var t=this.components[e.name];if(this.alive)for(var s=0;s<this.queries.length;s++){var o=this.queries[s];o.reactive&&-1!==o.Components.indexOf(e)&&o.eventDispatcher.dispatchEvent(Query.prototype.COMPONENT_CHANGED,this,t)}return t}addComponent(e,t){if(!~this.componentTypes.indexOf(e)){this.componentTypes.push(e),e.isSystemStateComponent&&this._numSystemStateComponents++;var s=this.world.getComponentPool(e),o=void 0===s?new e(t):s.acquire();return s&&t&&o.copy(t),this.components[e.name]=o,this.alive&&this.world.onComponentAdded(this,e),this}}hasComponent(e,t){return!!~this.componentTypes.indexOf(e)||!0===t&&this.hasRemovedComponent(e)}hasRemovedComponent(e){return!!~this._componentTypesToRemove.indexOf(e)}hasAllComponents(e){for(var t=0;t<e.length;t++)if(!this.hasComponent(e[t]))return!1;return!0}hasAnyComponents(e){for(var t=0;t<e.length;t++)if(this.hasComponent(e[t]))return!0;return!1}removeComponent(e,t){const s=e.name;if(!this._componentsToRemove[s]){delete this.components[s];const t=this.componentTypes.indexOf(e);this.componentTypes.splice(t,1),this.world.onRemoveComponent(this,e)}const o=this.components[s];if(t){if(o&&o.dispose(),this._componentsToRemove[s]){delete this._componentsToRemove[s];const t=this._componentTypesToRemove.indexOf(e);-1!==t&&this._componentTypesToRemove.splice(t,1)}}else this._componentTypesToRemove.push(e),this._componentsToRemove[s]=o,this.world.queueComponentRemoval(this,e);return e.isSystemStateComponent&&(this._numSystemStateComponents--,0!==this._numSystemStateComponents||this.alive||this.dispose()),!0}processRemovedComponents(){for(;this._componentTypesToRemove.length>0;){let e=this._componentTypesToRemove.pop();this.removeComponent(e,!0)}}removeAllComponents(e){let t=this.componentTypes;for(let s=t.length-1;s>=0;s--)this.removeComponent(t[s],e)}copy(e){for(const t in e.components){const s=e.components[t];this.components[t]=s.clone(),this.componentTypes.push(s.constructor)}return this}clone(){return new this.constructor(this.world).copy(this)}dispose(e){if(this.alive&&this.world.onDisposeEntity(this),e){this.uuid=generateUUID(),this.alive=!0;for(let e=0;e<this.queries.length;e++)this.queries[e].removeEntity(this);for(const e in this.components)this.components[e].dispose(),delete this.components[e];for(const e in this._componentsToRemove)delete this._componentsToRemove[e];this.queries.length=0,this.componentTypes.length=0,this._componentTypesToRemove.length=0,this._pool&&this._pool.release(this),this.world.onEntityDisposed(this)}else this.alive=!1,this.world.queueEntityDisposal(this)}}Types.set(Entity,{default:void 0,copy:copyCopyable});class ObjectPool{constructor(e,t){this.freeList=[],this.count=0,this.baseObject=e,this.isObjectPool=!0,void 0!==t&&this.expand(t)}acquire(){return this.freeList.length<=0&&this.expand(Math.round(.2*this.count)+1),this.freeList.pop()}release(e){e.copy(this.baseObject),this.freeList.push(e)}expand(e){for(var t=0;t<e;t++){const e=this.baseObject.clone();e._pool=this,this.freeList.push(e)}this.count+=e}totalSize(){return this.count}totalFree(){return this.freeList.length}totalUsed(){return this.count-this.freeList.length}}class World{constructor(){if(this.systemManager=new SystemManager(this),this.entityPool=new ObjectPool(new Entity(this)),this.entities=[],this.entitiesByUUID={},this.entitiesWithComponentsToRemove=[],this.entitiesToRemove=[],this.deferredRemovalEnabled=!0,this.componentTypes={},this.componentPools={},this.componentCounts={},this.queries={},this.enabled=!0,"undefined"!=typeof CustomEvent){var e=new CustomEvent("ecsy-world-created",{detail:{world:this,version:Version}});window.dispatchEvent(e)}this.lastTime=performance.now()}registerComponent(e,t){if(!this.componentTypes[e.name])return this.componentTypes[e.name]=e,this.componentCounts[e.name]=0,!1===t?t=void 0:void 0===t&&(t=new ObjectPool(new e)),this.componentPools[e.name]=t,this;console.warn(`Component type: '${e.name}' already registered.`)}registerSystem(e,t){return this.systemManager.registerSystem(e,t),this}createEntity(){const e=this.createDetachedEntity();return this.addEntity(e)}createDetachedEntity(){return this.entityPool.acquire()}addEntity(e){return this.entitiesByUUID[e.uuid]?(console.warn(`Entity ${e.uuid} already added.`),e):(this.entitiesByUUID[e.uuid]=e,this.entities.push(e),e.alive=!0,e)}getEntityByUUID(e){return this.entitiesByUUID[e]}createComponent(e){const t=this.componentPools[e.name];return t?t.acquire():new e}getComponentPool(e){return this.componentPools[e.name]}getSystem(e){return this.systemManager.getSystem(e)}getSystems(){return this.systemManager.getSystems()}getQuery(e){const t=queryKey(e);let s=this.queries[t];return s||(this.queries[t]=s=new Query(e,this)),s}onComponentAdded(e,t){for(var s in this.componentTypes[t.name]||console.warn(`Component ${t.name} not registered.`),this.componentCounts[t.name]++,this.queries){var o=this.queries[s];~o.NotComponents.indexOf(t)&&~o.entities.indexOf(e)?o.removeEntity(e):~o.Components.indexOf(t)&&o.match(e)&&!~o.entities.indexOf(e)&&o.addEntity(e)}}queueComponentRemoval(e){-1===this.entitiesWithComponentsToRemove.indexOf(e)&&this.entitiesWithComponentsToRemove.push(e)}onRemoveComponent(e,t){for(var s in this.componentCounts[t.name]--,this.queries){var o=this.queries[s];~o.NotComponents.indexOf(t)&&!~o.entities.indexOf(e)&&o.match(e)?o.addEntity(e):~o.Components.indexOf(t)&&~o.entities.indexOf(e)&&!o.match(e)&&o.removeEntity(e)}}queueEntityDisposal(e){this.entitiesToRemove.push(e)}onDisposeEntity(e){for(var t in this.queries){const s=this.queries[t];-1!==e.queries.indexOf(s)&&s.removeEntity(e)}}onEntityDisposed(e){if(!this.entitiesByUUID[e.uuid])return;delete this.entitiesByUUID[e.uuid];const t=this.entities.indexOf(e);-1!==t&&this.entities.splice(t,1)}execute(e,t){if(!e){let t=performance.now();e=t-this.lastTime,this.lastTime=t}if(this.enabled){if(this.systemManager.execute(e,t),!this.deferredRemovalEnabled)return;for(let e=0;e<this.entitiesToRemove.length;e++){this.entitiesToRemove[e].dispose(!0)}this.entitiesToRemove.length=0;for(let e=0;e<this.entitiesWithComponentsToRemove.length;e++){this.entitiesWithComponentsToRemove[e].processRemovedComponents()}this.entitiesWithComponentsToRemove.length=0}}stop(){this.enabled=!1}play(){this.enabled=!0}stats(){var e={entities:{numEntities:this.entities.length,numQueries:Object.keys(this.queries).length,queries:{},numComponentPool:Object.keys(this.componentPools).length,componentPool:{}},system:this.systemManager.stats()};for(const t in this.queries)e.queries[t]=this.queries[t].stats();for(const t in this.componentPools){const s=this.componentPools[t];e.componentPool[t]={used:s.totalUsed(),size:s.count}}console.log(JSON.stringify(e,null,2))}}class System{canExecute(){if(0===this._mandatoryQueries.length)return!0;for(let e=0;e<this._mandatoryQueries.length;e++){if(0===this._mandatoryQueries[e].entities.length)return!1}return!0}constructor(e,t){if(this.world=e,this.enabled=!0,this._queries={},this.queries={},this.priority=0,this.executeTime=0,t&&t.priority&&(this.priority=t.priority),this._mandatoryQueries=[],this.initialized=!0,this.constructor.queries)for(var s in this.constructor.queries){var o=this.constructor.queries[s],n=o.components;if(!n||0===n.length)throw new Error("'components' attribute can't be empty in a query");var i=this.world.getQuery(n);this._queries[s]=i,!0===o.mandatory&&this._mandatoryQueries.push(i),this.queries[s]={results:i.entities};const e={added:Query.prototype.ENTITY_ADDED,removed:Query.prototype.ENTITY_REMOVED,changed:Query.prototype.COMPONENT_CHANGED};o.listen&&["added","removed","changed"].forEach(t=>{if(o.listen[t]){let n=o.listen[t];if("changed"===t){if(i.reactive=!0,!0===n){let e=this.queries[s][t]=[];i.eventDispatcher.addEventListener(Query.prototype.COMPONENT_CHANGED,t=>{-1===e.indexOf(t)&&e.push(t)})}else if(Array.isArray(n)){let e=this.queries[s][t]=[];i.eventDispatcher.addEventListener(Query.prototype.COMPONENT_CHANGED,(t,s)=>{-1!==n.indexOf(s.constructor)&&-1===e.indexOf(t)&&e.push(t)})}}else{let o=this.queries[s][t]=[];i.eventDispatcher.addEventListener(e[t],e=>{-1===o.indexOf(e)&&o.push(e)})}}})}}stop(){this.executeTime=0,this.enabled=!1}play(){this.enabled=!0}clearEvents(){for(let t in this.queries){var e=this.queries[t];if(e.added&&(e.added.length=0),e.removed&&(e.removed.length=0),e.changed)if(Array.isArray(e.changed))e.changed.length=0;else for(let t in e.changed)e.changed[t].length=0}}toJSON(){var e={name:this.constructor.name,enabled:this.enabled,executeTime:this.executeTime,priority:this.priority,queries:{}};if(this.constructor.queries){var t=this.constructor.queries;for(let s in t){let o=this.queries[s],n=t[s],i=e.queries[s]={key:this._queries[s].key};if(i.mandatory=!0===n.mandatory,i.reactive=n.listen&&(!0===n.listen.added||!0===n.listen.removed||!0===n.listen.changed||Array.isArray(n.listen.changed)),i.reactive){i.listen={},["added","removed","changed"].forEach(e=>{o[e]&&(i.listen[e]={entities:o[e].length})})}}}return e}}function Not(e){return{operator:"not",Component:e}}class Component{constructor(e){const t=this.constructor.schema;for(const s in t){const o=t[s];if(e&&e.hasOwnProperty(s))this[s]=e[s];else if(o.hasOwnProperty("default")){const e=Types.get(o.type);this[s]=e.clone(o.default)}else{const e=Types.get(o.type);this[s]=e.clone(e.default)}}this._pool=null}copy(e){const t=this.constructor.schema;for(const s in e)if(t.hasOwnProperty(s)){const o=t[s];Types.get(o.type).copy(e,this,s)}return this}clone(){return(new this.constructor).copy(this)}dispose(){this._pool&&this._pool.release(this)}}Component.schema={},Component.isComponent=!0,Types.set(Component,{default:void 0,copy:copyCopyable});class SystemStateComponent extends Component{constructor(e){super(e),this.isSystemStateComponent=!0}}SystemStateComponent.isSystemStateComponent=!0;class TagComponent extends Component{constructor(){super(),this.isTagComponent=!0}}function generateId(e){for(var t="",s="ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789",o=s.length,n=0;n<e;n++)t+=s.charAt(Math.floor(Math.random()*o));return t}function injectScript(e,t){var s=document.createElement("script");s.src=e,s.onload=t,(document.head||document.documentElement).appendChild(s)}function hookConsoleAndErrors(e){["error","warning","log"].forEach(t=>{if("function"==typeof console[t]){var s=console[t].bind(console);console[t]=(...o)=>(e.send({method:"console",type:t,args:JSON.stringify(o)}),s.apply(null,o))}}),window.addEventListener("error",t=>{e.send({method:"error",error:JSON.stringify({message:t.error.message,stack:t.error.stack})})})}function includeRemoteIdHTML(e){let t=document.createElement("div");return t.style.cssText="\n    align-items: center;\n    background-color: #333;\n    color: #aaa;\n    display:flex;\n    font-family: Arial;\n    font-size: 1.1em;\n    height: 40px;\n    justify-content: center;\n    left: 0;\n    opacity: 0.9;\n    position: absolute;\n    right: 0;\n    text-align: center;\n    top: 0;\n  ",t.innerHTML=`Open ECSY devtools to connect to this page using the code:&nbsp;<b style="color: #fff">${e}</b>&nbsp;<button onClick="generateNewCode()">Generate new code</button>`,document.body.appendChild(t),t}function enableRemoteDevtools(remoteId){window.generateNewCode=()=>{window.localStorage.clear(),remoteId=generateId(6),window.localStorage.setItem("ecsyRemoteId",remoteId),window.location.reload(!1)},remoteId=remoteId||window.localStorage.getItem("ecsyRemoteId"),remoteId||(remoteId=generateId(6),window.localStorage.setItem("ecsyRemoteId",remoteId));let infoDiv=includeRemoteIdHTML(remoteId);window.__ECSY_REMOTE_DEVTOOLS_INJECTED=!0,window.__ECSY_REMOTE_DEVTOOLS={};let Version="",worldsBeforeLoading=[],onWorldCreated=e=>{var t=e.detail.world;Version=e.detail.version,worldsBeforeLoading.push(t)};window.addEventListener("ecsy-world-created",onWorldCreated);let onLoaded=()=>{var peer=new Peer(remoteId);peer.on("open",()=>{peer.on("connection",connection=>{window.__ECSY_REMOTE_DEVTOOLS.connection=connection,connection.on("open",(function(){infoDiv.innerHTML="Connected",connection.on("data",(function(data){if("init"===data.type){var script=document.createElement("script");script.setAttribute("type","text/javascript"),script.onload=()=>{script.parentNode.removeChild(script),window.removeEventListener("ecsy-world-created",onWorldCreated),worldsBeforeLoading.forEach(e=>{var t=new CustomEvent("ecsy-world-created",{detail:{world:e,version:Version}});window.dispatchEvent(t)})},script.innerHTML=data.script,(document.head||document.documentElement).appendChild(script),script.onload(),hookConsoleAndErrors(connection)}else if("executeScript"===data.type){let value=eval(data.script);data.returnEval&&connection.send({method:"evalReturn",value:value})}}))}))})})};injectScript("https://cdn.jsdelivr.net/npm/peerjs@0.3.20/dist/peer.min.js",onLoaded)}TagComponent.isTagComponent=!0;const urlParams=new URLSearchParams(window.location.search);urlParams.has("enable-remote-devtools")&&enableRemoteDevtools(),exports.Component=Component,exports.Not=Not,exports.ObjectPool=ObjectPool,exports.System=System,exports.SystemStateComponent=SystemStateComponent,exports.TagComponent=TagComponent,exports.Types=Types,exports.Version=Version,exports.World=World,exports.cloneArray=cloneArray,exports.cloneClonable=cloneClonable,exports.cloneJSON=cloneJSON,exports.cloneValue=cloneValue,exports.copyArray=copyArray,exports.copyCopyable=copyCopyable,exports.copyJSON=copyJSON,exports.copyValue=copyValue,exports.enableRemoteDevtools=enableRemoteDevtools,Object.defineProperty(exports,"__esModule",{value:!0})}));
